{% extends 'base.html' %}

{% block title %}Настройки - FitWave AI{% endblock %}

{% block extra_css %}
<style>
    .settings-nav {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
    }

    .settings-nav .nav-link {
        color: var(--text);
        padding: 0.75rem 1rem;
        border-radius: 8px;
        transition: all 0.2s ease;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }

    .settings-nav .nav-link:hover {
        background: var(--card-hover);
        color: var(--primary);
    }

    .settings-nav .nav-link.active {
        background: var(--primary);
        color: white;
    }

    .settings-content {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 2rem;
    }

    .setting-item {
        background: var(--input);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
    }

    .setting-item:hover {
        border-color: var(--border-hover);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--border);
        transition: .4s;
        border-radius: 34px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: var(--primary);
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    .danger-zone {
        border: 2px solid var(--danger);
        border-radius: 12px;
        padding: 1.5rem;
        background: rgba(239, 68, 68, 0.05);
    }

    .stats-card {
        background: var(--input);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
    }

    .stats-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-1">Настройки</h1>
            <p class="text-muted mb-0">Управление аккаунтом и приложением</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-3 mb-4">
            <div class="settings-nav">
                <nav class="nav nav-pills flex-column">
                    <button class="nav-link active" data-tab="profile">
                        <i class="fas fa-user me-2"></i>Профиль
                    </button>
                    <button class="nav-link" data-tab="health">
                        <i class="fas fa-heartbeat me-2"></i>Здоровье
                    </button>
                    <button class="nav-link" data-tab="notifications">
                        <i class="fas fa-bell me-2"></i>Уведомления
                    </button>
                    <button class="nav-link" data-tab="privacy">
                        <i class="fas fa-shield-alt me-2"></i>Приватность
                    </button>
                    <button class="nav-link" data-tab="app">
                        <i class="fas fa-cog me-2"></i>Приложение
                    </button>
                    <button class="nav-link" data-tab="account">
                        <i class="fas fa-user-cog me-2"></i>Аккаунт
                    </button>
                </nav>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="settings-content" id="profile-tab" style="display: block;">
                <h4 class="mb-4">Личная информация</h4>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="tab" value="profile">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Имя</label>
                            <input type="text" class="form-control" name="first_name"
                                   value="{{ user.first_name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Фамилия</label>
                            <input type="text" class="form-control" name="last_name"
                                   value="{{ user.last_name }}">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email"
                               value="{{ user.email }}" required>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Возраст</label>
                            <input type="number" class="form-control" name="age"
                                   value="{{ profile.age|default:'' }}" min="10" max="100">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Пол</label>
                            <select class="form-control" name="gender">
                                <option value="">Выберите</option>
                                <option value="M" {% if profile.gender == 'M' %}selected{% endif %}>Мужской</option>
                                <option value="F" {% if profile.gender == 'F' %}selected{% endif %}>Женский</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Рост (см)</label>
                            <input type="number" class="form-control" name="height"
                                   value="{{ profile.height|default:'' }}" min="100" max="250">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Сохранить изменения
                    </button>
                </form>
            </div>

            <div class="settings-content" id="health-tab" style="display: none;">
                <h4 class="mb-4">Параметры здоровья</h4>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-value">{{ profile.bmi|floatformat:1|default:"—" }}</div>
                            <div class="text-muted">BMI</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-value">{{ profile.tdee|default:"—" }}</div>
                            <div class="text-muted">TDEE</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-value">{{ profile.current_weight|default:"—" }}</div>
                            <div class="text-muted">Вес (кг)</div>
                        </div>
                    </div>
                </div>

                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="tab" value="health">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Текущий вес (кг)</label>
                            <input type="number" class="form-control" name="current_weight"
                                   value="{{ profile.current_weight|default:'' }}" step="0.1" min="30" max="300">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Целевой вес (кг)</label>
                            <input type="number" class="form-control" name="target_weight"
                                   value="{{ profile.target_weight|default:'' }}" step="0.1" min="30" max="300">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Цель</label>
                            <select class="form-control" name="goal">
                                <option value="lose" {% if profile.goal == 'lose' %}selected{% endif %}>Снижение веса</option>
                                <option value="maintain" {% if profile.goal == 'maintain' %}selected{% endif %}>Поддержание веса</option>
                                <option value="gain" {% if profile.goal == 'gain' %}selected{% endif %}>Набор массы</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Уровень активности</label>
                            <select class="form-control" name="activity_level">
                                <option value="1.2" {% if profile.activity_level == 1.2 %}selected{% endif %}>Минимальная (офис)</option>
                                <option value="1.375" {% if profile.activity_level == 1.375 %}selected{% endif %}>1-3 тренировки/неделя</option>
                                <option value="1.55" {% if profile.activity_level == 1.55 %}selected{% endif %}>3-5 тренировок/неделя</option>
                                <option value="1.725" {% if profile.activity_level == 1.725 %}selected{% endif %}>6-7 тренировок/неделя</option>
                                <option value="1.9" {% if profile.activity_level == 1.9 %}selected{% endif %}>Очень высокая активность</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Пищевые предпочтения</label>
                        <textarea class="form-control" name="dietary_preferences" rows="3"
                                  placeholder="Например: вегетарианство, кето-диета, без глютена">{{ profile.dietary_preferences|default:'' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Аллергии</label>
                        <input type="text" class="form-control" name="allergies"
                               value="{{ profile.allergies|default:'' }}"
                               placeholder="Перечислите через запятую">
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Обновить параметры
                    </button>
                </form>
            </div>

            <div class="settings-content" id="notifications-tab" style="display: none;">
                <h4 class="mb-4">Уведомления</h4>

                <div class="setting-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Темная тема</h6>
                            <small class="text-muted">Использовать темное оформление интерфейса</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkThemeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Напоминания о тренировках</h6>
                            <small class="text-muted">Получать уведомления о запланированных тренировках</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Напоминания о питании</h6>
                            <small class="text-muted">Уведомления о приемах пищи и калориях</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item">
                    <h6 class="mb-2">Единицы измерения</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Вес</label>
                            <select class="form-control">
                                <option value="kg" selected>Килограммы</option>
                                <option value="lbs">Фунты</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Рост</label>
                            <select class="form-control">
                                <option value="cm" selected>Сантиметры</option>
                                <option value="ft">Футы</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Применить настройки
                </button>
            </div>

            <div class="settings-content" id="privacy-tab" style="display: none;">
                <h4 class="mb-4">Приватность и безопасность</h4>

                <div class="setting-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Публичный профиль</h6>
                            <small class="text-muted">Разрешить другим пользователям видеть ваш прогресс</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Аналитика использования</h6>
                            <small class="text-muted">Помочь улучшить приложение через анонимную аналитику</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Сохранение фотографий</h6>
                            <small class="text-muted">Хранить загруженные фото для анализа прогресса</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <hr class="my-4">

                <h6 class="mb-3">Управление данными</h6>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i>Экспорт данных
                    </button>
                    <button class="btn btn-outline-warning">
                        <i class="fas fa-eraser me-2"></i>Очистить кеш
                    </button>
                </div>
            </div>

            <div class="settings-content" id="app-tab" style="display: none;">
                <h4 class="mb-4">Настройки приложения</h4>

                <div class="setting-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Автосохранение</h6>
                            <small class="text-muted">Автоматически сохранять прогресс при выходе</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item">
                    <h6 class="mb-2">Язык интерфейса</h6>
                    <select class="form-control" style="max-width: 200px;">
                        <option value="ru" selected>Русский</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                    </select>
                </div>

                <button class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Сохранить настройки
                </button>
            </div>

            <div class="settings-content" id="account-tab" style="display: none;">
                <h4 class="mb-4">Управление аккаунтом</h4>

                <div class="setting-item">
                    <h6 class="mb-3">Изменить пароль</h6>
                    <form id="changePasswordForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Текущий пароль</label>
                                <input type="password" class="form-control" name="current_password" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Новый пароль</label>
                                <input type="password" class="form-control" name="new_password" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Подтвердите пароль</label>
                                <input type="password" class="form-control" name="confirm_password" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-key me-2"></i>Изменить пароль
                        </button>
                    </form>
                </div>

                <div class="setting-item">
                    <h6 class="mb-3">Активные сессии</h6>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-desktop me-2 text-primary"></i>
                                <div>
                                    <div class="fw-bold">Текущий браузер</div>
                                    <small class="text-muted">Chrome на Windows • Москва • Сейчас</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-success">Активно</span>
                        </div>
                    </div>
                    <button class="btn btn-outline-warning">
                        <i class="fas fa-sign-out-alt me-2"></i>Завершить все сессии
                    </button>
                </div>

                <hr class="my-4">

                <div class="danger-zone">
                    <h6 class="text-danger mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>Опасная зона
                    </h6>

                    <div class="mb-3">
                        <h6>Очистить все данные</h6>
                        <p class="text-muted mb-2">Удалить все ваши тренировки, анализы и прогресс</p>
                        <button class="btn btn-outline-warning" onclick="confirmAction('clear')">
                            <i class="fas fa-eraser me-2"></i>Очистить данные
                        </button>
                    </div>

                    <div>
                        <h6>Удалить аккаунт</h6>
                        <p class="text-muted mb-2">Окончательно удалить ваш аккаунт и все связанные данные</p>
                        <button class="btn btn-danger" onclick="confirmAction('delete')">
                            <i class="fas fa-trash me-2"></i>Удалить аккаунт
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">Подтверждение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmActionBtn">Подтвердить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.settings-nav .nav-link');
        const tabContents = document.querySelectorAll('.settings-content');

        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');

                navLinks.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                tabContents.forEach(content => {
                    content.style.display = 'none';
                });

                const targetContent = document.getElementById(targetTab + '-tab');
                if (targetContent) {
                    targetContent.style.display = 'block';
                }
            });
        });

        const darkThemeToggle = document.getElementById('darkThemeToggle');
        if (darkThemeToggle) {
            darkThemeToggle.addEventListener('change', function() {
                const theme = this.checked ? 'dark' : 'light';
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);

                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) {
                    themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                }
            });
        }

        const passwordForm = document.getElementById('changePasswordForm');
        if (passwordForm) {
            passwordForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const newPassword = formData.get('new_password');
                const confirmPassword = formData.get('confirm_password');

                if (newPassword !== confirmPassword) {
                    showNotification('Пароли не совпадают', 'danger');
                    return;
                }

                if (newPassword.length < 8) {
                    showNotification('Пароль должен содержать минимум 8 символов', 'warning');
                    return;
                }

                try {
                    const response = await axios.post('/api/auth/change-password/', formData);

                    if (response.status === 200) {
                        showNotification('Пароль успешно изменен', 'success');
                        this.reset();
                    }
                } catch (error) {
                    console.error('Password change error:', error);
                    showNotification('Ошибка при изменении пароля', 'danger');
                }
            });
        }
    });

    function confirmAction(action) {
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const title = document.getElementById('confirmModalTitle');
        const body = document.getElementById('confirmModalBody');
        const confirmBtn = document.getElementById('confirmActionBtn');

        if (action === 'clear') {
            title.textContent = 'Очистить все данные?';
            body.innerHTML = `
                <p>Это действие удалит:</p>
                <ul>
                    <li>Все ваши тренировки и прогресс</li>
                    <li>Анализы осанки и состава тела</li>
                    <li>Записи о питании</li>
                    <li>Фотографии и измерения</li>
                </ul>
                <p class="text-warning"><strong>Это действие нельзя отменить!</strong></p>
            `;
            confirmBtn.textContent = 'Очистить данные';
            confirmBtn.onclick = () => clearUserData();
        } else if (action === 'delete') {
            title.textContent = 'Удалить аккаунт?';
            body.innerHTML = `
                <p>Это действие окончательно удалит ваш аккаунт и все связанные данные.</p>
                <p class="text-danger"><strong>Это действие нельзя отменить!</strong></p>
                <div class="mt-3">
                    <label class="form-label">Введите ваш email для подтверждения:</label>
                    <input type="email" class="form-control" id="confirmEmail" placeholder="{{ user.email }}">
                </div>
            `;
            confirmBtn.textContent = 'Удалить аккаунт';
            confirmBtn.onclick = () => deleteAccount();
        }

        modal.show();
    }

    async function clearUserData() {
        try {
            const response = await axios.post('/api/auth/clear-data/');

            if (response.status === 200) {
                showNotification('Все данные очищены', 'success');
                bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
                setTimeout(() => location.reload(), 2000);
            }
        } catch (error) {
            console.error('Clear data error:', error);
            showNotification('Ошибка при очистке данных', 'danger');
        }
    }

    async function deleteAccount() {
        const confirmEmail = document.getElementById('confirmEmail').value;

        if (confirmEmail !== '{{ user.email }}') {
            showNotification('Email не совпадает', 'warning');
            return;
        }

        try {
            const response = await axios.post('/api/auth/delete-account/', {
                email: confirmEmail
            });

            if (response.status === 200) {
                showNotification('Аккаунт удален', 'success');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            }
        } catch (error) {
            console.error('Delete account error:', error);
            showNotification('Ошибка при удалении аккаунта', 'danger');
        }
    }

    function showNotification(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
        alertDiv.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>
{% endblock %}